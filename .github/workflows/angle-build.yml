name: build-angle-libs

permissions:
  contents: write

on:
  push:
    branches:
      - main
      - ci-tests
  pull_request:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    if: github.event_name != 'release' || github.event.release.target_commitish == 'main'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x64
            runner: ubuntu-latest
            target_os: linux
            target_cpu: x64
            sysroot: amd64
            vulkan: false
          - label: linux-x64-vulkan
            runner: ubuntu-latest
            target_os: linux
            target_cpu: x64
            sysroot: amd64
            vulkan: true
          - label: linux-x86
            runner: ubuntu-latest
            target_os: linux
            target_cpu: x86
            sysroot: i386
            vulkan: false
          - label: linux-x86-vulkan
            runner: ubuntu-latest
            target_os: linux
            target_cpu: x86
            sysroot: i386
            vulkan: true
          - label: linux-arm64
            runner: ubuntu-latest
            target_os: linux
            target_cpu: arm64
            sysroot: arm64
            vulkan: false
          - label: linux-arm64-vulkan
            runner: ubuntu-latest
            target_os: linux
            target_cpu: arm64
            sysroot: arm64
            vulkan: true
          - label: macos-arm64
            runner: macos-14
            target_os: mac
            target_cpu: arm64
            vulkan: false
          - label: macos-arm64-vulkan
            runner: macos-14
            target_os: mac
            target_cpu: arm64
            vulkan: true
          - label: macos-x64
            runner: macos-15-intel
            target_os: mac
            target_cpu: x64
            vulkan: false
          - label: macos-x64-vulkan
            runner: macos-15-intel
            target_os: mac
            target_cpu: x64
            vulkan: true
          - label: windows-x86
            runner: windows-latest
            target_os: win
            target_cpu: x86
            vulkan: false
          - label: windows-x86-vulkan
            runner: windows-latest
            target_os: win
            target_cpu: x86
            vulkan: true
          - label: windows-x64
            runner: windows-latest
            target_os: win
            target_cpu: x64
            vulkan: false
          - label: windows-x64-vulkan
            runner: windows-latest
            target_os: win
            target_cpu: x64
            vulkan: true
          - label: windows-arm64
            runner: windows-latest
            target_os: win
            target_cpu: arm64
            vulkan: false
          - label: windows-arm64-vulkan
            runner: windows-latest
            target_os: win
            target_cpu: arm64
            vulkan: true
          - label: ios-arm64
            runner: macos-14
            target_os: ios
            target_cpu: arm64
            vulkan: false

    env:
      DEPOT_TOOLS_WIN_TOOLCHAIN: "0"
      TARGET_OS: ${{ matrix.target_os }}
      TARGET_CPU: ${{ matrix.target_cpu }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up depot_tools
        shell: bash
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git depot_tools
          echo "$(pwd)/depot_tools" >> "$GITHUB_PATH"

      - name: Fetch ANGLE
        shell: bash
        run: |
          REVISION="$(cat "$GITHUB_WORKSPACE/REVISION")"
          mkdir -p angle
          cd angle
          cat > .gclient <<'EOF'
          solutions = [
            {
              "name": ".",
              "url": "https://chromium.googlesource.com/angle/angle.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_vars": {},
              "revision": "REVISION_PLACEHOLDER",
            },
          ]
          EOF
          sed -i.bak "s#REVISION_PLACEHOLDER#${REVISION}#g" .gclient
          rm -rf _bad_scm
          gclient sync --no-history --revision ".@${REVISION}" --reset
      - name: Make static libs distributable
        shell: bash
        run: |
          if [ "${RUNNER_OS}" = "Windows" ]; then
            git -C angle config core.autocrlf false
            git -C angle checkout -- .
          fi
          git -C angle apply --check --ignore-whitespace --ignore-space-change \
            "$GITHUB_WORKSPACE/patches/angle-static-libs.patch"
          git -C angle apply --ignore-whitespace --ignore-space-change \
            "$GITHUB_WORKSPACE/patches/angle-static-libs.patch"
      - name: Patch build repo (Windows arm64 dbghelp)
        shell: bash
        run: |
          if [ -d "angle/build/.git" ]; then
            if [ "${RUNNER_OS}" = "Windows" ]; then
              git -C angle/build config core.autocrlf false
              git -C angle/build checkout -- .
            fi
            git -C angle/build apply --check --ignore-whitespace --ignore-space-change \
              "$GITHUB_WORKSPACE/patches/build-win-skip-debugger-dlls.patch"
            git -C angle/build apply --ignore-whitespace --ignore-space-change \
              "$GITHUB_WORKSPACE/patches/build-win-skip-debugger-dlls.patch"
          fi

      - name: Install Linux deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cd angle
          sudo ./build/install-build-deps.sh --no-prompt
          build/linux/sysroot_scripts/install-sysroot.py --arch=${{ matrix.sysroot }}

      - name: Prepare Xcode (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          sudo xcodebuild -runFirstLaunch || true

      - name: Generate build files (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd angle
          args='is_debug=false is_component_build=false symbol_level=0 target_cpu="${{ matrix.target_cpu }}" target_os="${{ matrix.target_os }}"'
          if [ "${TARGET_OS}" = "ios" ]; then
            args="${args} ios_enable_code_signing=false target_environment=\"device\""
          fi
          if [ "${RUNNER_OS}" = "macOS" ]; then
            args="${args} mac_sdk_version=\"14.5\" mac_sdk_min=\"14.0\""
          fi
          if [ "${{ matrix.vulkan }}" = "true" ]; then
            args="${args} angle_enable_vulkan=true angle_enable_vulkan_system_info=true"
          else
            args="${args} angle_enable_vulkan=false angle_enable_vulkan_system_info=false"
          fi
          gn gen out/Release --args="${args}"

      - name: Generate build files (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd angle
          sdk_root="/c/Program Files (x86)/Windows Kits/10/Include"
          required_sdk="10.0.26100.0"
          echo "Available Windows SDKs:"
          ls "$sdk_root" || true
          if [ ! -d "$sdk_root/$required_sdk" ]; then
            echo "Required Windows SDK ${required_sdk} not found under ${sdk_root}."
            exit 1
          fi
          echo "Using Windows SDK ${required_sdk}"
          args="is_debug=false is_component_build=false symbol_level=0 target_cpu=\"${{ matrix.target_cpu }}\" windows_sdk_version=\"${required_sdk}\""
          if [ "${TARGET_CPU}" = "arm64" ]; then
            args="${args} dawn_use_built_dxc=false"
          fi
          if [ "${{ matrix.vulkan }}" = "true" ]; then
            args="${args} angle_enable_vulkan=true angle_enable_vulkan_system_info=true"
          else
            args="${args} angle_enable_vulkan=false angle_enable_vulkan_system_info=false"
          fi
          gn gen out/Release --args="${args}"

      - name: Build shared + static libs
        shell: bash
        run: |
          cd angle
          autoninja -C out/Release libEGL libGLESv2 libGLESv2_static libEGL_static

      - name: Package artifacts
        shell: bash
        run: |
          set -euo pipefail
          cd angle
          mkdir -p ../dist
          out_dir="out/Release"
          rev="$(cat "$GITHUB_WORKSPACE/REVISION")"
          safe_rev="${rev#refs/heads/}"
          safe_rev="${safe_rev#refs/tags/}"
          safe_rev="${safe_rev//\//-}"
          pkg="angle-${{ matrix.label }}-${safe_rev}"
          staging="../dist/${pkg}"
          mkdir -p "${staging}"
          case "${RUNNER_OS}" in
            Linux)
              for f in libEGL libGLESv2; do
                [ -f "${out_dir}/${f}.so" ] && cp "${out_dir}/${f}.so" "${staging}/"
              done
              if [ -f "${out_dir}/libGLESv2_static.a" ]; then
                cp "${out_dir}/libGLESv2_static.a" "${staging}/"
              elif [ -f "${out_dir}/obj/libGLESv2_static.a" ]; then
                cp "${out_dir}/obj/libGLESv2_static.a" "${staging}/"
              fi
              ;;
            macOS)
              if [ "${TARGET_OS}" = "ios" ]; then
                for f in libEGL_static libGLESv2_static; do
                  if [ -f "${out_dir}/${f}.a" ]; then
                    cp "${out_dir}/${f}.a" "${staging}/"
                  elif [ -f "${out_dir}/obj/${f}.a" ]; then
                    cp "${out_dir}/obj/${f}.a" "${staging}/"
                  fi
                done
              else
                for f in libEGL libGLESv2; do
                  [ -f "${out_dir}/${f}.dylib" ] && cp "${out_dir}/${f}.dylib" "${staging}/"
                done
                if [ -f "${out_dir}/libGLESv2_static.a" ]; then
                  cp "${out_dir}/libGLESv2_static.a" "${staging}/"
                elif [ -f "${out_dir}/obj/libGLESv2_static.a" ]; then
                  cp "${out_dir}/obj/libGLESv2_static.a" "${staging}/"
                fi
              fi
              ;;
            Windows)
              for f in libEGL libGLESv2; do
                [ -f "${out_dir}/${f}.dll" ] && cp "${out_dir}/${f}.dll" "${staging}/"
                [ -f "${out_dir}/${f}.lib" ] && cp "${out_dir}/${f}.lib" "${staging}/"
              done
              if [ -f "${out_dir}/libGLESv2_static.lib" ]; then
                cp "${out_dir}/libGLESv2_static.lib" "${staging}/"
              elif [ -f "${out_dir}/obj/libGLESv2_static.lib" ]; then
                cp "${out_dir}/obj/libGLESv2_static.lib" "${staging}/"
              fi
              ;;
          esac
          if [ -d "include" ]; then
            cp -R "include" "${staging}/"
          fi
          if [ -f "LICENSE" ]; then
            cp "LICENSE" "${staging}/"
          fi
          tar -C ../dist -czf "../dist/${pkg}.tar.gz" "${pkg}"

      - name: Set artifact name
        shell: bash
        run: |
          rev="$(cat "$GITHUB_WORKSPACE/REVISION")"
          safe_rev="${rev#refs/heads/}"
          safe_rev="${safe_rev#refs/tags/}"
          safe_rev="${safe_rev//\//-}"
          echo "ARTIFACT_NAME=angle-${{ matrix.label }}-${safe_rev}" >> "$GITHUB_ENV"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: dist/*.tar.gz
          if-no-files-found: error

      - name: Publish to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz

  bundle-all:
    needs: build
    if: github.event_name != 'release' || github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Bundle all platforms
        shell: bash
        run: |
          set -euo pipefail
          rev="$(cat "$GITHUB_WORKSPACE/REVISION")"
          safe_rev="${rev#refs/heads/}"
          safe_rev="${safe_rev#refs/tags/}"
          safe_rev="${safe_rev//\//-}"
          bundle="angle-all-${safe_rev}.tar.gz"
          mkdir -p dist/all
          find dist -type f -name '*.tar.gz' -exec cp {} dist/all/ \;
          tar -C dist -czf "dist/${bundle}" all
          echo "ALL_BUNDLE_NAME=angle-all-${safe_rev}" >> "$GITHUB_ENV"

      - name: Upload bundled artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ALL_BUNDLE_NAME }}
          path: dist/angle-all-*.tar.gz
          if-no-files-found: error

      - name: Publish bundled artifact to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/angle-all-*.tar.gz
